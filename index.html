<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LF Phase-shift Test</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <h1>Low Frequency Phase-shift Test</h1>


    <datalist id="ticksPlus1ZeroMinus1">
        <option value="-1">
        <option value="0">
        <option value="1">
    </datalist>

    <datalist id="ticksPlus2ZeroMinus2">
        <option value="-2">
        <option value="-1.5">
        <option value="-1" label="-π">
        <option value="-0.5">
        <option value="0"  label="0">
        <option value="0.5">
        <option value="1"  label="π">
        <option value="1.5">
        <option value="2">
    </datalist>




    <datalist id="ticksPlus1Zero">
        <option value="0">
        <option value="1">
    </datalist>

    <datalist id="ticks0half1">
        <option value="0">
        <option value="0.5">
        <option value="1">
    </datalist>


    <div class="bordered" id="CommonSettings">
        <h3>Sound Settings</h3>
        <div class="slider-container">
            <label for="freq">Frequency:</label>
            <input type="range" id="freq" name="frequency" min="20" max="200" step="1" value="50">
            <output  class="valueSpan" name="frequency">50Hz</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Frequency of first harmonic (fundamental)</div>
        </div>

        
        <div class="presetHeader topSpaced">
            <h4>Harmonic Series</h4>
            <div id="wavePresetButtons" class="PresetButtons"></div>
        </div>
        <div class="slider-container">
            <label for="balance">Balance (1st↔higher):</label>
            <input type="range" id="balance" name="balance" min="-1" max="1" step="0.001" value="0" list="ticksPlus1ZeroMinus1">
            <output class="valueSpan" name="balance">same</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls the balance between the first harmonic and the others.</div>
        </div>
        <div class="slider-container">
            <label for="even">Even Level:</label>
            <input type="range" id="even" name="evenLevel" min="-1" max="1" step="0.1" value="-1" class="mid-slider" list="ticksPlus1ZeroMinus1">
            <label for="evenAlternating"  class="flipLabel">Alt Amt:</label>
            <input type="range" id="evenAlternating" name="evenAlt" min="0" max="1" step="0.1" value="0" class="short-slider" list="ticksPlus1Zero">
            <output class="valueSpan" name="even">-1</output>
            <span class="help-icon">?</span>
            <div class="help-popup">First slider controls the level and polarity of the harmonics. The second slider controls how much the polarity alternates, full on will alternate polarity for each harmonic added. </div>
        </div>
        <div class="slider-container">
            <label for="evenFalloff">Even Fall off:</label>
            <input type="range" id="evenFalloff" name="evenFalloff" min="1" max="2" step="0.1" value="1.8">
            <output class="valueSpan" name="evenFalloff">1/n<sup>1.8</sup></output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls how loud higher harmonics are. For even harmonics, 1/n is typical of sawtooth waves.</div>
        </div>

        <div class="slider-container">
            <label for="odd">Odd Level:</label>
            <input type="range" id="odd" name="oddLevel" min="-1" max="1" step="0.1" value="1" class="mid-slider" list="ticksPlus1ZeroMinus1">
            <label for="oddAlternating"  class="flipLabel">Alt Amt:</label>
            <input type="range" id="oddAlternating" name="oddAlt" min="0" max="1" step="0.1" value="0" class="short-slider" list="ticksPlus1Zero">
            <output class="valueSpan" name="odd">1</output>
            <span class="help-icon">?</span>
            <div class="help-popup">First slider controls the level and polarity of the harmonics. The second slider controls how much the polarity alternates, full on will alternate polarity for each harmonic added. </div>
        </div>
        <div class="slider-container">
            <label for="oddFalloff">Odd Fall off:</label>
            <input type="range" id="oddFalloff" name="oddFalloff" min="1" max="2" step="0.1" value="1.8">
            <output class="valueSpan" name="oddFalloff">1/n<sup>1.8</sup></output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls how loud higher harmonics are. For odd harmonics, 1/n is typical of square and sawtooth waves, 1/n^2 is like a triangle wave.</div>
        </div>
        <div class="slider-container">
            <label for="SineToCos">Phase at t=0</label>
            <input type="range" id="SineToCos" name="sinCos" min="-1" max="1" step="0.1" value="0" class="longish-slider" list="ticksPlus1ZeroMinus1">
            <output class="valueSpan longOut" name="sinCos">0</output>
            <span class="help-icon">?</span>
            <div class="help-popup">A fixed phase offset for all harmonics, adjust the phase of waves at t=0. Needed for pulse waves</div>
        </div>
        <div class="slider-container">
            <label for="altW">Alternation Freq:</label>
            <input type="range" id="altW" name="altW" min="0" max="1" step="0.05" value="0.5" class="longish-slider" list="ticks0half1">
            <output class="valueSpan longOut" name="altW">0</output>
            <span class="help-icon">?</span>
            <div class="help-popup">How often the polarity alternates as harmonics are added, the polarity. Usually at 2 to when set of harmonics to alternate (eg triangle). Equivalent to the duty cycle when set up for a pulse wave and values other than 2 used.</div>
        </div>
        <div class="slider-container">
            <label for="altOffset">Alternation Offset:</label>
            <input type="range" id="altOffset" name="altOffset" min="-1" max="1" step="0.1" value="0.0" class="longish-slider" list="ticksPlus1ZeroMinus1">
            <output class="valueSpan longOut" name="altOffset">0</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Adjusts where the positive, negative and zero values of the alternations falls. When at zero, with Alternation Freq set to 2, the alternations fall on odd harmonics. Change to +/-1 to fall on even harmonics.</div>
        </div>      
        <div>
            <canvas id="wavePreview"  width ="800" height="200"></canvas>
        </div>
        <div class ="previewButtons">
            <div class="previewButtons previewL">
                <button name="PD" class = "previewButton">def</button>
                <button name="PA" class = "previewButton">A</button>
                <button name="PB" class = "previewButton">B</button>
            </div>
            <div class="previewButtons previewC">
                <button name="F0" class = "previewButton">off</button>
                <button name="F1" class = "previewButton">F1</button>
                <button name="F2" class = "previewButton">F2</button>
                <button name="F3" class = "previewButton">F3</button>
            </div>

            <div class="previewButtons">
                <button name="HFull" class = "previewButton">Full</button>
                <button name="HPhase" class = "previewButton">Φ</button>
                <button name="HPolarity" class = "previewButton">+/-</button>
            </div>
        </div>

        <div class="presetHeader topSpaced">
            <h4>Envelope</h4>
            <div id="envelopPresetButtons" class="PresetButtons"></div>
        </div>
        <div class="slider-container">
            <label for="attack">Attack:</label>
            <input type="range" id="attack" name="attack" min="0.001" max="0.2" step="0.001" value="0.005">
            <output class="valueSpan" name="attack">0.005s</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls the time for the linear attack part of the envelope</div>
        </div>

        <div class="slider-container">
            <label for="hold">Hold:</label>
            <input type="range" id="hold" name="hold" min="0.00" max="1" step="0.01" value="0.0">
            <output class="valueSpan" name="hold">0s</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls the time held at maximum between attack and decay</div>
        </div>

        <div class="slider-container">
            <label for="decay">Decay:</label>
            <input type="range" id="decay" name="decay" min="0.01" max="2" step="0.01" value="0.4">
            <output class="valueSpan" name="decay">0.4s</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls the time for the exponential decay part of the envelope to fall to -60db</div>
        </div>

        <div class="slider-container">
            <label for="envelopeFilter">Smoothing:</label>
            <input type="range" id="envelopeFilter" name="envelopeFilter" min="0" max="1000" step="10" value="150">
            <output class="valueSpan" name="envelopeFilter">150</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls the cut-off of the low pass filter which smooths the envelope. 0=off, 1000 = very very low cutoff frequency</div>
        </div>
    </div>
    <div class="bordered" id="FilterSetup">
        <div class="presetHeader">
            <h3>Filter Settings</h3>
            <div id="filterPresetButtons" class="PresetButtons"></div>
        </div>

        <div class="slider-container">
            <label for="filterSlope">Slope</label>
            <input type="range" id="filterSlope" name="filterSlope" min="0" max="96" step="1" value="12">
            <output class="valueSpan" name="filterSlope">12db/octave</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Slope of filter after cut-off</div>
        </div>

        <div class="slider-container">
            <label for="filterF1">Frequency f1:</label>
            <input type="range" id="filterF1" name="filterF1" min="0" max="10" step="0.01" value="10">
            <output class="valueSpan" name="filterF1">20000Hz</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Start frequency of filter</div>
        </div>

        <div class="slider-container">
            <label for="filterF2">Frequency f2:</label>
            <input type="range" id="filterF2" name="filterF2" min="0" max="10" step="0.01" value="10">
            <output class="valueSpan" name="filterF2">20000Hz</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Hold (or end of attack) frequency of filter</div>
        </div>

        <div class="slider-container">
            <label for="filterF3">Frequency f3:</label>
            <input type="range" id="filterF3" name="filterF3" min="0" max="10" step="0.01" value="10">
            <output class="valueSpan" name="filterF3">20000Hz</output>
            <span class="help-icon">?</span>
            <div class="help-popup">End frequency of filter</div>
        </div>

        <div class="slider-container">
            <label for="attackF">Attack (f1→f2):</label>
            <input type="range" id="attackF" name="attackF" min="0.001" max="0.2" step="0.001" value="0.005">
            <output class="valueSpan" name="attackF">0.005s</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls the time for the linear (in frequency) attack of filter envelope</div>
        </div>

        <div class="slider-container">
            <label for="holdF">Hold (f2):</label>
            <input type="range" id="holdF" name="holdF" min="0.00" max="1" step="0.01" value="0.0">
            <output class="valueSpan" name="holdF">0s</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls the time filter held at maximum between attack and decay</div>
        </div>

        <div class="slider-container">
            <label for="decayF">Decay (f2→f3):</label>
            <input type="range" id="decayF" name="decayF" min="0.01" max="2" step="0.01" value="0.4">
            <output class="valueSpan" name="decayF">0.4s</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls the time for the linear (in frequency) decay of filter envelope</div>
        </div>

    </div>


    <div class="bordered" id="DistortionSetup">
        <div class="presetHeader">
            <h3>Distortion Settings</h3>
            <div id="distortionPresets" class="PresetButtons"></div>
        </div>
     
        <div>
            <canvas id="distortionPreview"  width ="800" height="200"></canvas>
        </div>
        <div class ="previewButtons bottomSpaced">
            <div class="previewButtons previewL">
                <button name="PD" class = "previewButton">def</button>
                <button name="PA" class = "previewButton">A</button>
                <button name="PB" class = "previewButton">B</button>
            </div>
            <div class="previewButtons previewC">
                <button name="F0" class = "previewButton">off</button>
                <button name="F1" class = "previewButton">F1</button>
                <button name="F2" class = "previewButton">F2</button>
                <button name="F3" class = "previewButton">F3</button>
            </div>

            <div class="previewButtons">
                <button name="DFull" class = "previewButton">Full</button>
                <button name="DPhase" class = "previewButton">Φ</button>
                <button name="DPolarity" class = "previewButton">+/-</button>
            </div>
        </div>

        <div class="slider-container">
            <label for="distortion">Amount:</label>
            <input type="range" id="distortion" name="distortion" min="0" max="1" step="0.01" value="0">
            <output class="valueSpan" name="distortion">0%</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls the amount of distortion</div>
        </div>
    </div>



    <div class="bordered" id="TestSetup">
        <h3>Phase shift settings</h3>
        <h4>Root Phase shift</h4>
        <div class="slider-container">
            <label for="rootPhaseDelay">Root Phase Shift:</label>
            <input type="range" id="rootPhaseDelay" name="rootPhaseDelay" min="-2" max="2" step="0.05" value="0" list="ticksPlus2ZeroMinus2">
            <output class="valueSpan" name="rootPhaseDelay">0π (0ms)</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Phase delay of first harmonic for Sound A. Affects 2nd harmonic according to settings in common section.</div>
        </div>

        <h4>Envelope Mode</h4>
        <div class="slider-container">
            <label for="envMode"   class="modeLabel modeLabelLeft">Delay envelope with phase-shift</label>
            <input type="range" id="envMode" name="envMode" min="1" max="2" step="1" value="1" class="short-slider">
            <span   class="modeLabel modeLabelRight">Fixed envelope for all harmonics</span>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls whether the envelope of a each harmonic is shifted so the it starts with phase=0 of the harmonic or if all harmonics start at the same time but with shifted phases</div>
        </div>

        <h4>Higher harmonic shift</h4>
        <div class="slider-container">
            <label for="second">Relative Phase delay:</label>
            <input type="range" id="second" name="higherHarmonicRelativeShift" min="0" max="1" step="0.1" value="0">
            <output class="valueSpan" name="higherHarmonicRelativeShift">0</output>
            <span class="help-icon">?</span>
            <div class="help-popup">Controls how much the higher harmonics (if present) are delayed. It is relative to amount of phase delay on the first harmonic. 0 means no delay and 1 means same phase delay as first harmonic.</div>
        </div>

    </div>
    
    <div class="bordered">
        <h3>FFT</h3>
        <div class="fftPlayButtons">
            <button id="fftPlayA" class="fftPlayButton">Play A</button>
            <button id="fftPlayB" class="fftPlayButton">Play B</button>
            <button id="fftPlayN" class="fftPlayButton">Play Null</button>
        </div>
        <div>
            <canvas id="fftCanvas" width ="800" height="200"></canvas>
        </div>
        <p>Only really useful for testing and development. Set to "Tone" envelope preset.</p>
        <button id="hideFFT">Hide FFT</button>
    </div>


    <div class="bordered">
        <h3>Null test <span id="nullTestdb"></span></h3>        
        <div>
            <canvas id="waveformNull" width ="800" height="200"></canvas>
        </div>
        <button id="playSoundNull">Play</button>
        <p>See <a href="#Notes1">explanation of Null Test</a></p>
    </div>


    <!--**********************************************************************-->
    <!--*****************  Start ABX Setup and Test  *************************-->
    <!--**********************************************************************-->

    <div class="bordered"  id="SoundASetup">
        <h3>Sound A</h3>
        <div>
            <canvas id="waveformA"  class="waveformCanvas" width ="800" height="200"></canvas>
        </div>
        <button id="playSoundA">Play A</button>
    </div>



    <div class="bordered" id="SoundBSetup">
        <h3>Sound B</h3>
        <div>
            <canvas id="waveformB"  class="waveformCanvas" width ="800" height="200"></canvas>
        </div>
        <button id="playSoundB">Play B</button>
    </div>

    <br>


    <div id="centerContainer">
        <div id="abxTestContainer">
            <h3>ABX test</h3>
            <ol id="results"></ol>
            <button id="abxTest" class="testCenter">Test</button>
            <div id="abxButtons"  style="display: none;">
                <button id="buttonA">X is A</button>
                <button id="play">Play X</button>
                <button id="buttonB">X is B</button>
            </div>
            <p id="stats" class="testCenter"></p>
            <br>
            <button id="resetTest"  class="testCenter" style="display: none;">Reset Test</button>
        </div>
    </div>
    <div class="bordered">
        <h3>Background info - see <a href="#Notes1">notes</a></h3>
        <div class ="previewButtons">
            <div class="previewButtons">
                <button name="wShowF" class = "previewButton">Filter overlays</button>
                <button name="wShowEG" class = "previewButton">Envelope overlays</button>
            </div>
        </div>
    </div>

    <!--**********************************************************************-->
    <!--*******************  End ABX Setup and Test  *************************-->
    <!--**********************************************************************-->
    
    

    <div id="Notes1" class="bordered">
        <h3>Notes: Background</h3>
        <p>This page was created to help investigate audibility of low frequency phase shifts.</p>
        <p>It generates two sounds with identical harmonic content and envelopes as set by the common controls.</p>
        <p>By default, each sound has the phase of the first harmonic shifted by the specified amount relative to the other harmonics. Higher harmonic can also be phase shifted by a specified fraction of the root phase shift.</p>
        <p>The CheckBoxes next to each slider allow those parameters to be selected for testing. They will appear in the Sound A and Sound B boxes allowing them to be independently set for each sound.</p>
        <p>An envelope with linear attack and exponential decay is applied to each harmonic. The envelope is band limited by an adjustable low-pass filter. </p>
        <p>By default, the envelopes of the first (and other if specified) harmonics are delayed by the same amount as the phase delay for that harmonic but this delay can be removed.</p>  
        <p>The waves are normalised together so their relative size are unchanged. This is to keep to optimum loudness levels for tests, avoiding clipping or the sounds being too quiet.</p> 
        <p>Negative phase shifts are there to allow trying to compensate for existing phase shifts in playback systems.</p>
        <p>The code is plain javascript, using the browsers own Web Audio API for playback, to allow for easy modification and review of methodology etc.</p>
        <p>The waves are generated using additive synthesis to allow for easy and predictable setting of phases and levels.</p>
        <p>The filter is a simulated Butterworth response but with no phase shift. It is intended just for altering harmonic content to try out different sounds The filter envelope is linear but moves the frequency as if it were an exponential control.</p>
    </div>
    
    <div id="Notes2" class="bordered">
        <h3>Notes: Null test</h3>
        <p>This null test is a sanity check for the generated waveforms.</p>
        <p>Play back and image of the null test result is of the normalised version. Peak level is measured before any normalising.</p> 
        <p>The null test should only contain the first harmonic (and second if it is shifted, too) plus a little distortion for short attacks and/or low smoothing due to offset attack starts.</p>
        <p>Changes to harmonics controls should not affect the sound of the null test result (with no second harmonic shift).</p>
        <p>The null test is messed up if either phase shift is negative because then the algorithm delays the higher harmonics instead and leaves the first harmonic at the start.</p>  
        <p>The envelope offset will affect the null results. Increase the hold time to generate a constant level section to give more predictable null test results.</p> 
        <p>With a significant hold time and no second harmonic shift, an offset of pi should and does give 6db and with pi/2 should and does give 3db. With 2Pi, the hold section should and does null, but the offset envelopes will cause a difference to appear during attack and decay.</p>
    </div>
    <script src="defaults.js"></script>
    <script src="distortion.js"></script>
    <script src="audio.js"></script>
    <script src="painting.js"></script>
    <script src="audioAPI.js"></script>
    <script src="gui.js"></script>
</body>
</html>